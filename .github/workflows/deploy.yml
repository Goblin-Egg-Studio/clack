name: Deploy to Linode

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v1

      - name: Install Linode CLI
        run: |
          pip install linode-cli
          echo "✅ Linode CLI installed"

      - name: Get Linode IP
        id: get-ip
        run: |
          echo "🔍 Getting Linode instance IP..."
          LINODE_IP=$(curl -H "Authorization: Bearer ${{ secrets.LINODE_API_TOKEN }}" \
            "https://api.linode.com/v4/linode/instances/${{ secrets.LINODE_INSTANCE_ID }}" | \
            jq -r '.ipv4[0]')
          echo "ip=$LINODE_IP" >> $GITHUB_OUTPUT
          echo "📍 Linode IP: $LINODE_IP"

      - name: Deploy to Linode
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ steps.get-ip.outputs.ip }}
          username: clack
          key: ${{ secrets.LINODE_SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "🚀 Starting deployment..."
            
            # Navigate to project directory
            cd /opt/clack
            
            # Pull latest changes
            echo "📥 Pulling latest changes..."
            git pull origin main
            
            # Install dependencies
            echo "📦 Installing dependencies..."
            bun install --no-progress --frozen-lockfile
            
            # Build the application
            echo "🔨 Building application..."
            bun run build
            
            # Restart the service
            echo "🔄 Restarting service..."
            sudo systemctl restart clack
            
            # Check service status
            echo "✅ Checking service status..."
            sudo systemctl status clack --no-pager
            
            echo "🎉 Deployment completed successfully!"

      - name: Restart Linode Instance
        run: |
          echo "🔄 Restarting Linode instance..."
          curl -H "Authorization: Bearer ${{ secrets.LINODE_API_TOKEN }}" \
            -X POST \
            "https://api.linode.com/v4/linode/instances/${{ secrets.LINODE_INSTANCE_ID }}/reboot"
          echo "✅ Linode instance restart initiated"




