name: Deploy to Linode

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v1

      - name: Deploy via Linode API
        run: |
          echo "ğŸš€ Starting pure API deployment..."
          
          # Get Linode instance details
          echo "ğŸ” Getting Linode instance details..."
          LINODE_IP=$(curl -H "Authorization: Bearer ${{ secrets.LINODE_API_TOKEN }}" \
            "https://api.linode.com/v4/linode/instances/${{ secrets.LINODE_INSTANCE_ID }}" | \
            jq -r '.ipv4[0]')
          
          echo "ğŸ“ Linode IP: $LINODE_IP"
          
          # Create deployment user data script
          echo "ğŸ“ Creating deployment user data..."
          cat > user_data.sh << 'EOF'
          #!/bin/bash
          set -e
          echo "ğŸš€ GitHub Actions deployment triggered..."
          
          # Wait for system to be ready
          sleep 30
          
          # Navigate to project directory
          cd /opt/clack
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main
          
          # Install dependencies
          echo "ğŸ“¦ Installing dependencies..."
          bun install --no-progress --frozen-lockfile
          
          # Build the application
          echo "ğŸ”¨ Building application..."
          bun run build
          
          # Restart the service
          echo "ğŸ”„ Restarting service..."
          sudo systemctl restart clack
          
          # Check service status
          echo "âœ… Checking service status..."
          sudo systemctl status clack --no-pager
          
          echo "ğŸ‰ Deployment completed successfully!"
          EOF
          
          # Update Linode instance with new user data
          echo "ğŸ“¤ Updating Linode instance with deployment script..."
          curl -H "Authorization: Bearer ${{ secrets.LINODE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -X PUT \
            -d "{\"user_data\": \"$(base64 -w 0 user_data.sh)\"}" \
            "https://api.linode.com/v4/linode/instances/${{ secrets.LINODE_INSTANCE_ID }}"
          
          # Reboot the instance to trigger user data execution
          echo "ğŸ”„ Rebooting Linode instance to execute deployment..."
          curl -H "Authorization: Bearer ${{ secrets.LINODE_API_TOKEN }}" \
            -X POST \
            "https://api.linode.com/v4/linode/instances/${{ secrets.LINODE_INSTANCE_ID }}/reboot"
          
          echo "â³ Waiting for deployment to complete..."
          sleep 120
          
          echo "âœ… Deployment completed via Linode API!"
          echo "ğŸ‰ Pure API deployment successful!"




